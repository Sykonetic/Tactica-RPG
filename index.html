<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Final Fantasy Tactics PvP</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            text-align: center; 
            background: #222; 
            color: #fff; 
            margin: 0; 
            padding: 10px; 
            touch-action: manipulation; 
        }
        #menu, #teamSelect, #classSelect { 
            position: fixed; 
            top: 0; left: 0; 
            width: 100%; height: 100%; 
            background: rgba(0,0,0,0.9); 
            display: flex; 
            flex-direction: column; 
            justify-content: center; 
            align-items: center; 
            z-index: 10; 
        }
        #menu button, #teamSelect button { 
            padding: 15px 30px; 
            margin: 8px;
            font-size: 20px; 
            background: #0066cc; 
            border: none; 
            border-radius: 8px; 
            color: #fff; 
            cursor: pointer; 
        }
        #teamSelect button.red { background: #cc0000; }
        #classSelect { 
            padding: 20px;
        }
        #classSelect button { 
            padding: 12px 20px; 
            margin: 10px; 
            font-size: 18px; 
            width: 220px; 
        }
        #classSelect .selected { border: 3px solid yellow; }
        #game { 
            display: none; 
        }
        #grid { 
            display: grid; 
            grid-template-columns: repeat(10, 1fr); 
            gap: 4px; 
            margin: 30px auto; 
            max-width: 850px; 
        }
        .cell { 
            width: min(80px, 9vw); 
            height: min(80px, 9vw); 
            background: #444; 
            border: 2px solid #888; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            cursor: pointer; 
            font-weight: bold; 
            font-size: min(32px, 7vw); 
            user-select: none; 
        }
        .cell:active { transform: scale(0.95); }
        .cell.blue { background: #0066cc !important; }
        .cell.red { background: #cc0000 !important; }
        .cell.selected { background: #88ff88 !important; border-color: #00ff00; }
        .cell.active { border: 4px solid yellow; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(255,255,0,0.7); } 70% { box-shadow: 0 0 0 10px rgba(255,255,0,0); } 100% { box-shadow: 0 0 0 0 rgba(255,255,0,0); } }
        .cell.obstacle { background: #000 !important; }
        .cell.height0 { background: #333 !important; }
        .cell.height1 { background: #555 !important; }
        .cell.height2 { background: #777 !important; }
        .cell.height3 { background: #999 !important; }
        .cell.height4 { background: #bbb !important; }
        #legend {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #333;
            border: 1px solid #555;
            padding: 15px;
            border-radius: 8px;
            width: 160px;
            z-index: 5;
            font-size: 14px;
        }
        .legend-item {
            display: flex;
            align-items: center;
            margin: 8px 0;
        }
        .legend-swatch {
            width: 30px;
            height: 30px;
            border: 1px solid #888;
            margin-right: 10px;
        }
        #controls { 
            display: flex; 
            flex-wrap: wrap; 
            justify-content: center; 
            gap: 10px; 
            margin: 20px 0; 
        }
        button { 
            padding: 15px 20px; 
            font-size: 18px; 
            min-height: 50px; 
            flex: 1 1 120px; 
            max-width: 150px; 
            border: none; 
            border-radius: 8px; 
            background: #444; 
            color: #fff; 
            cursor: pointer; 
        }
        button:active { background: #666; }
        #log { 
            height: 120px; 
            overflow-y: scroll; 
            border: 1px solid #555; 
            padding: 15px; 
            margin-top: 10px; 
            background: #333; 
            text-align: left; 
        }
        #hud, #skills { 
            background: #333; 
            border: 1px solid #555; 
            padding: 15px; 
            margin: 10px auto; 
            max-width: 600px; 
            display: none; 
        }
        @media (max-width: 600px) {
            .cell { width: 11vw; height: 11vw; font-size: 8vw; }
            #legend { position: static; margin: 20px auto; }
        }
    </style>
</head>
<body>
    <div id="menu">
        <h1>Final Fantasy Tactics PvP</h1>
        <button onclick="showTeamSelect()">Press to Start</button>
    </div>
    <div id="teamSelect" style="display:none;">
        <h2>Choose Team Color</h2>
        <button class="blue" onclick="showClassSelect('blue')">Blue Team</button>
        <button class="red" onclick="showClassSelect('red')">Red Team</button>
    </div>
    <div id="classSelect" style="display:none;">
        <h2>Select 3 Classes</h2>
        <div id="classButtons"></div>
        <button onclick="confirmClasses()">Confirm & Start</button>
    </div>
    <div id="game">
        <h2>Battle Session</h2>
        <div id="grid"></div>
        <div id="hud"></div>
        <div id="skills"></div>
        <div id="controls">
            <button onclick="move()">Move</button>
            <button onclick="attack()">Attack</button>
            <button onclick="showSkillsMenu()">Skill</button>
            <button onclick="wait()">Wait</button>
            <button onclick="shareBattle()">Share Code</button>
            <button onclick="loadBattle()">Load Code</button>
        </div>
        <input type="text" id="battleCode" placeholder="Battle ID" readonly>
        <div id="log"></div>
        <div id="legend">
            <h3>Terrain</h3>
            <div class="legend-item"><div class="legend-swatch obstacle"></div><div>Obstacle</div></div>
            <div class="legend-item"><div class="legend-swatch height4"></div><div>+40% Dmg</div></div>
            <div class="legend-item"><div class="legend-swatch height3"></div><div>+30% Dmg</div></div>
            <div class="legend-item"><div class="legend-swatch height2"></div><div>+20% Dmg</div></div>
            <div class="legend-item"><div class="legend-swatch height1"></div><div>+10% Dmg</div></div>
            <div class="legend-item"><div class="legend-swatch height0"></div><div>+0% Dmg</div></div>
        </div>
    </div>
    <script>
        const classesData = [
            {name: 'Warrior', icon: 'âš”ï¸', hp: 50, mp: 20, speed: 10, atk: 18, def: 20, mag: 5, range: 1, maxMove: 4, skills: ['Taunt', 'Cleave']},
            {name: 'Healer', icon: 'âœ¨', hp: 40, mp: 40, speed: 12, atk: 8, def: 12, mag: 18, range: 1, maxMove: 5, skills: ['Restore', 'Aura']},
            {name: 'Mage', icon: 'ðŸ”®', hp: 30, mp: 50, speed: 15, atk: 6, def: 8, mag: 20, range: 4, maxMove: 4, skills: ['Fireball', 'Frostbind']},
            {name: 'Archer', icon: 'ðŸ¹', hp: 35, mp: 30, speed: 16, atk: 17, def: 13, mag: 7, range: 5, maxMove: 5, skills: ['Pierce', 'Volley']},
            {name: 'Rogue', icon: 'ðŸ¥·', hp: 35, mp: 30, speed: 20, atk: 16, def: 9, mag: 6, range: 2, maxMove: 6, skills: ['Backstab', 'Vanish']}
        ];

        const state = {
            terrain: Array(100).fill(null),
            units: [],
            turnOrder: [],
            currentUnit: null,
            selectedCell: null,
            playerTeam: null,
            battleId: '',
            selectedClasses: []
        };

        const dirMap = { N: 'â†‘', S: 'â†“', E: 'â†’', W: 'â†' };
        const oppDir = { N: 'S', S: 'N', E: 'W', W: 'E' };

        function getFacingToTarget(unit, tx, ty) {
            const dx = tx - unit.x, dy = ty - unit.y;
            if (Math.abs(dx) > Math.abs(dy)) return dx > 0 ? 'E' : 'W';
            return dy > 0 ? 'S' : 'N';
        }

        function isBehind(attacker, target) {
            const relDir = getFacingToTarget(target, attacker.x, attacker.y);
            return relDir === oppDir[target.facing];
        }

        function manhattanDist(x1, y1, x2, y2) { return Math.abs(x1 - x2) + Math.abs(y1 - y2); }

        function getTerrain(x, y) { return state.terrain[y * 10 + x] || {height: 0}; }

        function hasLoS(x1, y1, x2, y2) {
            let dx = Math.abs(x2 - x1), dy = Math.abs(y2 - y1);
            let sx = x1 < x2 ? 1 : -1, sy = y1 < y2 ? 1 : -1;
            let err = dx - dy;
            let x = x1, y = y1;
            while (true) {
                if (getTerrain(x, y).type === 'obstacle') return false;
                if (x === x2 && y === y2) return true;
                let e2 = 2 * err;
                if (e2 > -dy) { err -= dy; x += sx; }
                if (e2 < dx) { err += dx; y += sy; }
            }
        }

        function isVisibleToTeam(unit, viewerTeam) {
            if (unit.team === viewerTeam) return true;
            return state.units.some(u => u.team === viewerTeam && u.hp > 0 && hasLoS(u.x, u.y, unit.x, unit.y));
        }

        function showTeamSelect() {
            document.getElementById('menu').style.display = 'none';
            document.getElementById('teamSelect').style.display = 'flex';
        }

        function showClassSelect(team) {
            state.playerTeam = team;
            document.getElementById('teamSelect').style.display = 'none';
            const container = document.getElementById('classButtons');
            container.innerHTML = '';
            classesData.forEach(cls => {
                const btn = document.createElement('button');
                btn.textContent = cls.icon + ' ' + cls.name + ` (Move: ${cls.maxMove})`;
                btn.onclick = () => {
                    btn.classList.toggle('selected');
                    const i = state.selectedClasses.indexOf(cls.name);
                    if (i > -1) state.selectedClasses.splice(i, 1);
                    else if (state.selectedClasses.length < 3) state.selectedClasses.push(cls.name);
                };
                container.appendChild(btn);
            });
            document.getElementById('classSelect').style.display = 'flex';
        }

        function confirmClasses() {
            if (state.selectedClasses.length !== 3) {
                alert('Please select exactly 3 classes');
                return;
            }
            state.battleId = crypto.randomUUID().slice(0, 8).toUpperCase();
            document.getElementById('battleCode').value = state.battleId;
            document.getElementById('classSelect').style.display = 'none';
            document.getElementById('game').style.display = 'block';
            setupUnits();
            init();
        }

        function setupUnits() {
            state.units = [];
            const positions = state.playerTeam === 'blue' ? [[2,2], [3,2], [4,2]] : [[7,7], [6,7], [8,7]];
            state.selectedClasses.forEach((name, i) => {
                const data = classesData.find(c => c.name === name);
                state.units.push({
                    id: state.playerTeam[0] + (i+1),
                    ...data,
                    facing: state.playerTeam === 'blue' ? 'N' : 'S',
                    x: positions[i][0],
                    y: positions[i][1],
                    hp: data.hp,
                    maxHp: data.hp,
                    mp: data.mp,
                    maxMp: data.mp,
                    team: state.playerTeam
                });
            });
        }

        function init() {
            for (let i = 0; i < 100; i++) {
                const rand = Math.random();
                if (rand < 0.08) state.terrain[i] = {type: 'obstacle', height: 0, passable: false};
                else state.terrain[i] = {type: 'height', height: Math.floor(rand * 5), passable: true};
            }
            state.units.forEach(u => state.terrain[u.y * 10 + u.x] = {type: 'height', height: 0, passable: true});

            state.turnOrder = [...state.units].sort((a, b) => b.speed - a.speed);
            renderGrid();
            nextTurn();
        }

        function renderGrid() {
            const gridEl = document.getElementById('grid');
            gridEl.innerHTML = '';
            for (let i = 0; i < 100; i++) {
                const cell = document.createElement('div');
                cell.className = 'cell';
                cell.dataset.x = i % 10;
                cell.dataset.y = Math.floor(i / 10);
                cell.addEventListener('click', () => selectCell(cell));
                cell.addEventListener('touchend', () => selectCell(cell), { passive: true });
                gridEl.appendChild(cell);
            }
            updateGrid();
        }

        function updateGrid() {
            document.querySelectorAll('.cell').forEach(cell => {
                const x = parseInt(cell.dataset.x);
                const y = parseInt(cell.dataset.y);
                const terr = getTerrain(x, y);
                cell.className = 'cell';
                if (terr.type === 'obstacle') cell.className += ' obstacle';
                else cell.className += ` height${terr.height}`;
                cell.textContent = '';
                const unit = state.units.find(u => u.x === x && u.y === y);
                if (unit && isVisibleToTeam(unit, state.playerTeam)) {
                    cell.className += ` ${unit.team}`;
                    if (unit === state.currentUnit) cell.className += ' active';
                    if (unit.team !== state.playerTeam) cell.className += ' foggy';
                    cell.textContent = unit.icon + dirMap[unit.facing];
                }
                if (state.selectedCell && state.selectedCell.x === x && state.selectedCell.y === y) {
                    cell.className += ' selected';
                }
            });
        }

        function selectCell(cell) {
            const x = parseInt(cell.dataset.x);
            const y = parseInt(cell.dataset.y);
            if (state.currentUnit && state.currentUnit.team !== state.playerTeam) return;
            state.selectedCell = { x, y };
            updateGrid();
            const unit = state.units.find(u => u.x === x && u.y === y);
            if (unit && isVisibleToTeam(unit, state.playerTeam)) updateHud(unit);
            else document.getElementById('hud').style.display = 'none';
        }

        function updateHud(unit) {
            const hud = document.getElementById('hud');
            hud.innerHTML = `
                <h3>${unit.name}</h3>
                <p>Move: ${unit.maxMove} tiles</p>
                <p>HP: <progress value="${unit.hp}" max="${unit.maxHp}"></progress> ${unit.hp}/${unit.maxHp}</p>
                <p>MP: <progress value="${unit.mp}" max="${unit.maxMp}"></progress> ${unit.mp}/${unit.maxMp}</p>
                <p>ATK ${unit.atk} | DEF ${unit.def} | MAG ${unit.mag} | SPD ${unit.speed}</p>
                <p>Skills: ${unit.skills.join(', ')}</p>
            `;
            hud.style.display = 'block';
        }

        function showSkillsMenu() {
            if (!state.currentUnit || state.currentUnit.team !== state.playerTeam) return;
            const skills = document.getElementById('skills');
            skills.innerHTML = '<button onclick="document.getElementById(\'skills\').style.display=\'none\'">Close</button>' + 
                state.currentUnit.skills.map(s => `<button onclick="useSkill('${s}')">${s}</button>`).join('');
            skills.style.display = 'block';
        }

        function useSkill(skill) {
            logMessage(`${state.currentUnit.name} used ${skill}! (stub)`);
            endTurn();
        }

        function nextTurn() {
            if (state.turnOrder.length === 0) return;
            do {
                state.currentUnit = state.turnOrder.shift();
                state.turnOrder.push(state.currentUnit);
            } while (state.currentUnit.hp <= 0);
            const myTurn = state.currentUnit.team === state.playerTeam;
            logMessage(`${state.currentUnit.name}'s turn - ${myTurn ? 'YOUR TURN!' : 'Opponent turn'}`);
            updateGrid();
        }

        function move() {
            if (!state.currentUnit || state.currentUnit.team !== state.playerTeam) return;
            const tx = state.selectedCell.x, ty = state.selectedCell.y;
            const terr = getTerrain(tx, ty);
            if (!terr.passable || state.units.some(u => u.x === tx && u.y === ty)) return;
            if (manhattanDist(state.currentUnit.x, state.currentUnit.y, tx, ty) > state.currentUnit.maxMove) return;
            state.currentUnit.x = tx;
            state.currentUnit.y = ty;
            state.currentUnit.facing = getFacingToTarget(state.currentUnit, tx, ty);
            updateGrid();
            logMessage(`${state.currentUnit.name} moved`);
            endTurn();
        }

        function attack() {
            if (!state.currentUnit || state.currentUnit.team !== state.playerTeam) return;
            const target = state.units.find(u => u.x === state.selectedCell.x && u.y === state.selectedCell.y && u.team !== state.currentUnit.team);
            if (!target || !isVisibleToTeam(target, state.playerTeam)) return;
            const dist = manhattanDist(state.currentUnit.x, state.currentUnit.y, target.x, target.y);
            if (dist > state.currentUnit.range || (dist > 1 && !hasLoS(state.currentUnit.x, state.currentUnit.y, target.x, target.y))) return;
            let dmg = Math.max(1, state.currentUnit.atk - target.def / 2);
            const heightDiff = getTerrain(state.currentUnit.x, state.currentUnit.y).height - getTerrain(target.x, target.y).height;
            dmg *= (1 + heightDiff * 0.1); // +10% per level
            if (state.currentUnit.name === 'Rogue' && isBehind(state.currentUnit, target)) dmg *= 2;
            target.hp -= Math.floor(dmg);
            logMessage(`${state.currentUnit.name} hits ${target.name} for ${Math.floor(dmg)}!`);
            if (target.hp <= 0) removeUnit(target);
            updateGrid();
            endTurn();
        }

        function wait() {
            if (!state.currentUnit || state.currentUnit.team !== state.playerTeam) return;
            logMessage(`${state.currentUnit.name} waits`);
            endTurn();
        }

        function endTurn() {
            state.selectedCell = null;
            document.getElementById('hud').style.display = 'none';
            document.getElementById('skills').style.display = 'none';
            nextTurn();
        }

        function removeUnit(unit) {
            state.units = state.units.filter(u => u.id !== unit.id);
            updateGrid();
        }

        function shareBattle() {
            const code = btoa(JSON.stringify(state));
            navigator.clipboard.writeText(code).then(() => logMessage('Code copied! Send to opponent'));
        }

        function loadBattle() {
            const code = prompt('Paste opponent code:');
            if (code) {
                try {
                    Object.assign(state, JSON.parse(atob(code)));
                    document.getElementById('game').style.display = 'block';
                    renderGrid();
                    nextTurn();
                    logMessage('Loaded - your turn if it's your team!');
                } catch (e) {
                    logMessage('Invalid code');
                }
            }
        }

        function logMessage(msg) {
            const log = document.getElementById('log');
            log.innerHTML += `<p>${msg}</p>`;
            log.scrollTop = log.scrollHeight;
        }
    </script>
</body>
</html>