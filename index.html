<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Final Fantasy Tactics PvP</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            text-align: center; 
            background: #222; 
            color: #fff; 
            margin: 0; 
            padding: 10px; 
            touch-action: manipulation; 
        }
        #menu, #teamSelect, #classSelect { 
            position: fixed; 
            top: 0; left: 0; 
            width: 100%; height: 100%; 
            background: rgba(0,0,0,0.9); 
            display: flex; 
            flex-direction: column; 
            justify-content: center; 
            align-items: center; 
            z-index: 10; 
        }
        #menu button, #teamSelect button, #classSelect button { 
            padding: 15px 30px; /* Smaller */
            margin: 8px;
            font-size: 20px; /* Smaller */
            background: #0066cc; 
            border: none; 
            border-radius: 8px; 
            color: #fff; 
            cursor: pointer; 
        }
        #teamSelect button.red, #classSelect button.red { background: #cc0000; }
        #classSelect .class-btn {
            width: 200px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        #classSelect .class-btn.selected { border: 3px solid yellow; }
        #game { 
            display: none; 
        }
        #container {
            display: flex;
            justify-content: center;
            gap: 30px;
            max-width: 95vw;
        }
        #main {
            flex: 1;
            max-width: 600px;
        }
        #grid { 
            display: grid; 
            grid-template-columns: repeat(10, 1fr); 
            gap: 2px; 
            margin: 20px auto; 
        }
        .cell { 
            width: min(60px, 7vw); 
            height: min(60px, 7vw); 
            background: #444; 
            border: 2px solid #888; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            cursor: pointer; 
            font-weight: bold; 
            font-size: min(18px, 4vw); 
            user-select: none; 
        }
        .cell:active { transform: scale(0.95); }
        .cell.blue { background: #0066cc !important; }
        .cell.red { background: #cc0000 !important; }
        .cell.selected { background: #88ff88 !important; border-color: #00ff00; }
        .cell.active { border: 4px solid yellow; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(255,255,0,0.7); } 70% { box-shadow: 0 0 0 10px rgba(255,255,0,0); } 100% { box-shadow: 0 0 0 0 rgba(255,255,0,0); } }
        .cell.obstacle { background: #000 !important; }
        .cell.height0 { background: #333 !important; }
        .cell.height1 { background: #555 !important; }
        .cell.height2 { background: #777 !important; }
        .cell.height3 { background: #999 !important; }
        .cell.height4 { background: #bbb !important; }
        #legend {
            background: #333;
            border: 1px solid #555;
            padding: 15px;
            border-radius: 8px;
            width: 180px;
            align-self: center;
            margin-top: 150px; /* Aligns roughly with lower half like your screenshot */
        }
        .legend-item {
            display: flex;
            align-items: center;
            margin: 12px 0;
            font-size: 14px;
        }
        .legend-swatch {
            width: 30px;
            height: 30px;
            border: 1px solid #888;
            margin-right: 10px;
        }
        #controls, #hud, #skills, #log { max-width: 600px; margin: 10px auto; }
        @media (max-width: 900px) {
            #container { flex-direction: column; align-items: center; }
            #legend { margin: 20px auto; }
        }
        @media (max-width: 600px) {
            .cell { width: min(70px, 9vw); height: min(70px, 9vw); }
        }
    </style>
</head>
<body>
    <div id="menu">
        <h1>Final Fantasy Tactics PvP</h1>
        <button onclick="showTeamSelect()">Press to Start</button>
    </div>
    <div id="teamSelect" style="display:none;">
        <h2>Choose Your Team Color</h2>
        <button class="blue" onclick="showClassSelect('blue')">Blue Team</button>
        <button class="red" onclick="showClassSelect('red')">Red Team</button>
    </div>
    <div id="classSelect" style="display:none;">
        <h2>Select 3 Classes</h2>
        <div id="classButtons"></div>
        <button onclick="confirmClasses()">Confirm Selection</button>
    </div>
    <div id="game">
        <h2>Battle Session</h2>
        <div id="container">
            <div id="main">
                <div id="grid"></div>
                <div id="hud"></div>
                <div id="skills"></div>
                <div id="controls">
                    <button onclick="move()">Move</button>
                    <button onclick="attack()">Attack</button>
                    <button onclick="showSkillsMenu()">Skill</button>
                    <button onclick="wait()">Wait</button>
                    <button onclick="shareBattle()">Share Code</button>
                    <button onclick="loadBattle()">Load Code</button>
                </div>
                <input type="text" id="battleCode" placeholder="Battle ID" readonly>
                <div id="log"></div>
            </div>
            <div id="legend">
                <h3>Terrain</h3>
                <div class="legend-item"><div class="legend-swatch obstacle"></div><div>Obstacle<br>Impassable</div></div>
                <div class="legend-item"><div class="legend-swatch height4"></div><div>+40% Dmg</div></div>
                <div class="legend-item"><div class="legend-swatch height3"></div><div>+30% Dmg</div></div>
                <div class="legend-item"><div class="legend-swatch height2"></div><div>+20% Dmg</div></div>
                <div class="legend-item"><div class="legend-swatch height1"></div><div>+10% Dmg</div></div>
                <div class="legend-item"><div class="legend-swatch height0"></div><div>+0% Dmg</div></div>
            </div>
        </div>
    </div>
    <script>
        const classes = [
            {name: 'Warrior', icon: 'âš”ï¸', hp: 50, mp: 20, speed: 10, atk: 18, def: 20, mag: 5, range: 1, maxMove: 4, skills: ['Taunt', 'Cleave']},
            {name: 'Healer', icon: 'âœ¨', hp: 40, mp: 40, speed: 12, atk: 8, def: 12, mag: 18, range: 1, maxMove: 5, skills: ['Restore', 'Aura']},
            {name: 'Mage', icon: 'ðŸ”®', hp: 30, mp: 50, speed: 15, atk: 6, def: 8, mag: 20, range: 4, maxMove: 4, skills: ['Fireball', 'Frostbind']},
            {name: 'Archer', icon: 'ðŸ¹', hp: 35, mp: 30, speed: 16, atk: 17, def: 13, mag: 7, range: 5, maxMove: 5, skills: ['Pierce', 'Volley']},
            {name: 'Rogue', icon: 'ðŸ¥·', hp: 35, mp: 30, speed: 20, atk: 16, def: 9, mag: 6, range: 2, maxMove: 6, skills: ['Backstab', 'Vanish']}
        ];

        const state = {
            terrain: Array(100).fill(null),
            units: [],
            turnOrder: [],
            currentUnit: null,
            selectedCell: null,
            playerTeam: null,
            battleId: '',
            selectedClasses: []
        };

        function showTeamSelect() {
            document.getElementById('menu').style.display = 'none';
            document.getElementById('teamSelect').style.display = 'flex';
        }

        function showClassSelect(team) {
            state.playerTeam = team;
            document.getElementById('teamSelect').style.display = 'none';
            const btnContainer = document.getElementById('classButtons');
            btnContainer.innerHTML = '';
            classes.forEach(cls => {
                const btn = document.createElement('button');
                btn.className = 'class-btn';
                btn.textContent = cls.icon + ' ' + cls.name + ` (Move: ${cls.maxMove})`;
                btn.onclick = () => {
                    btn.classList.toggle('selected');
                    const index = state.selectedClasses.indexOf(cls.name);
                    if (index > -1) state.selectedClasses.splice(index, 1);
                    else if (state.selectedClasses.length < 3) state.selectedClasses.push(cls.name);
                };
                btnContainer.appendChild(btn);
            });
            document.getElementById('classSelect').style.display = 'flex';
        }

        function confirmClasses() {
            if (state.selectedClasses.length !== 3) {
                alert('Select exactly 3 classes!');
                return;
            }
            state.battleId = crypto.randomUUID().slice(0, 8).toUpperCase();
            document.getElementById('battleCode').value = state.battleId;
            document.getElementById('classSelect').style.display = 'none';
            document.getElementById('game').style.display = 'block';
            setupUnits();
            init();
            logMessage(`You are ${state.playerTeam.toUpperCase()} team. Selected: ${state.selectedClasses.join(', ')}`);
        }

        function setupUnits() {
            state.units = [];
            const startPositions = state.playerTeam === 'blue' ? [[2,2], [3,2], [4,2]] : [[7,7], [6,7], [8,7]];
            state.selectedClasses.forEach((name, i) => {
                const cls = classes.find(c => c.name === name);
                state.units.push({
                    id: state.playerTeam[0] + (i+1),
                    ...cls,
                    name: cls.name,
                    class: cls.name,
                    facing: state.playerTeam === 'blue' ? 'N' : 'S',
                    x: startPositions[i][0],
                    y: startPositions[i][1],
                    hp: cls.hp,
                    maxHp: cls.hp,
                    mp: cls.mp,
                    maxMp: cls.mp,
                    team: state.playerTeam
                });
            });
            // Opponent will have their own when loading code
        }

        // Rest of code (init, renderGrid, updateGrid, fog, turns, actions, HUD with move range, etc.) same as previous full version

        function updateHud(unit) {
            const hudEl = document.getElementById('hud');
            hudEl.innerHTML = `
                <h3>${unit.name} (${unit.class})</h3>
                <p>Move: ${unit.maxMove} tiles</p>
                <p>HP: <progress value="${unit.hp}" max="${unit.maxHp}"></progress> ${unit.hp}/${unit.maxHp}</p>
                <p>MP: <progress value="${unit.mp}" max="${unit.maxMp}"></progress> ${unit.mp}/${unit.maxMp}</p>
                <p>Stats: ATK ${unit.atk} | DEF ${unit.def} | MAG ${unit.mag} | SPD ${unit.speed}</p>
                <p>Skills: ${unit.skills.join(', ')}</p>
            `;
            hudEl.style.display = 'block';
        }

        // LoadBattle will now handle class selection if units empty (opponent setup)

        // All other functions (hasLoS, isVisibleToTeam, move, attack with % height bonus, etc.) unchanged from last full version
    </script>
</body>
</html>